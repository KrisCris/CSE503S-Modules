<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatRoom</title>
    <link rel="stylesheet" href="view.css">
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
    <!-- login -->
    <div class="login">
        <img id="connStatus" src="./res/offline.png" alt="connStatus"><br>
        <input id="username" type="text" placeholder="Nickname"><br>
        <input id="password" type="password" placeholder="Password"><br>
        <button id="btnLogin">Login</button><br>
        <button id="btnReg">Register</button><br>
    </div>


    <div class="chatroom displayNone">
        <!-- namespaces -->
        <div class="namespaces">
            <div class="add">
                <input type="text" name="servername" id="joinServer">
                <a href="#" id="btnJoinServer">+</a>
            </div>
            
            <ul class="server-list">
                <li>
                    <a href="#">fadfasd</a>
                </li>
                <li>
                    <a href="#">fadfasd</a>
                </li>
                <li>
                    <a href="#">fadfasd</a>
                </li>
                <li>
                    <a href="#">fadfasd</a>
                </li>
            </ul>
        </div>

        <!-- rooms -->
        <div class="rooms">
            <ul class="room-list">
                <li>
                    <a href="#">fadfasd</a>
                </li>
                <li>
                    <a href="#">fadfasd</a>
                </li>
                
            </ul>

            <!-- user settings -->
            <div class="user">
                <button id="btnUser">Username</button>
                <button id="btnLogout">Logout</button>
            </div>
        </div>

        <!-- chats -->
        <div class="chats">
            <ul class="chat-list">
                <li>
                    <p>KrisCris 10/12/2021 14:23 :</p>
                    <a href="#">fadfasd</a>
                </li>
                <li>
                    <p>KrisCris 10/12/2021 14:23 :</p>
                    <a href="#">fadfasd</a>
                </li>
                <li>
                    <p>KrisCris 10/12/2021 14:23 :</p>
                    <a href="#">fadfasd</a>
                </li>
                <li>
                    <p>KrisCris 10/12/2021 14:23 :</p>
                    <a href="#">fadfasd</a>
                </li>
            </ul>
            <div class="text-field">
                <div contenteditable role="textbox" id="textarea">

                </div>
            </div>
        </div>

        <!-- members -->
        <div class="members">
            <ul class="member-list">
                <li>
                    <a href="#">fadfasd</a>
                </li>
            </ul>
        </div>
    </div>

    <script>
        // defalut namespace
        const dftSocket = io();
        dftSocket.on("connect", ()=>{
            document.getElementById("connStatus").setAttribute("src","./res/online.png");
        })
        dftSocket.on("disconnect", ()=>{
            document.getElementById("connStatus").setAttribute("src","data:image/png;base64,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")
        })

        document.addEventListener("DOMContentLoaded", ()=>{
            if(localStorage.token !== undefined){
                dftSocket.emit("tryRetriveStatus", {token:localStorage.token});
            }
        })
        
        // login
        const username = document.getElementById("username");
        const password = document.getElementById("password");
        const btnLogin = document.getElementById("btnLogin");
        const btnReg = document.getElementById("btnReg");
        const btnLogout = document.getElementById("btnLogout");

        dftSocket.on("loginResp", (res) =>{
            if(res["code"]==1){
                localStorage.token = res['data']['token'];
                initUserFunc()
            } else {
                if (res["code"] == -1){
                    alert(res['msg']);
                }
                initGuestFunc();
            }
        })

        btnLogin.addEventListener('click',e => {
            let uname = username.value;
            let upw = password.value;
            let regex = /^[\w_\.\-]+$/;
            if (!regex.test(uname) || upw == '') {
                alert("Invalid Input");
            } else {
                dftSocket.emit("tryLogin", {username:uname, password:upw});
            }
        });

        btnReg.addEventListener('click', e => {
            let uname = username.value;
            let upw = password.value;
            let regex = /^[\w_\.\-]+$/;
            if (!regex.test(uname) || upw == '') {
                alert("Invalid Input");
            } else {
                dftSocket.emit("tryReg", {username:uname, password:upw});
            }
        })

        btnLogout.addEventListener('click', e => {
            dftSocket.emit("logout");
        })

        const loginPage = document.getElementsByClassName("login")[0];
        const chatPage = document.getElementsByClassName("chatroom")[0];

        function initUserFunc(){
            chatPage.classList.remove("displayNone");
            loginPage.classList.add("displayNone");
        }

        function initGuestFunc(){
            localStorage.token = undefined;
            chatPage.classList.add("displayNone");
            loginPage.classList.remove("displayNone");
        }




        // styling textarea
        const textarea = document.getElementById("textarea");
        const chatList = document.getElementsByClassName("chat-list")[0];
        function fixHeight() {
            let flag = false;
            let parent = textarea.parentNode;
            let rem = 1.2;
            let base = rem * parseFloat(getComputedStyle(document.documentElement).fontSize);
            if (chatList.scrollHeight - chatList.offsetHeight == chatList.scrollTop) {
                flag = true;
            }
            parent.style.height = '5rem';
            parent.style.height = (textarea.scrollHeight + base) + "px";
            chatList.style.bottom = (textarea.scrollHeight + base) + "px";

            if (flag) {
                chatList.scroll(chatList.scrollWidth, chatList.scrollHeight);
            }
        }
        textarea.addEventListener("input", fixHeight)
        textarea.addEventListener('paste', function (e) {
            e.preventDefault()
            let text = e.clipboardData.getData('text/plain')
            for (let t of text.split("\n")) {
                e.target.append(t);
                e.target.append(document.createElement("br"));
            }
            e.target.removeChild(e.target.lastChild);
            e.target.append(text);
            fixHeight();
        })
        textarea.addEventListener('keydown', function (e) {
            function _clear() {
                removeAllChildNodes(textarea);
                fixHeight();
            }

            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (textarea.innerHTML.replaceAll("<br>", "").replaceAll("&nbsp;", "").replaceAll(" ", "") == "") {
                    _clear();
                    return;
                }

                let li = document.createElement("li");

                let p = document.createElement('p');
                p.append("KrisCris 10/12/2021 14:23 :");
                li.append(p)
                
                let a = document.createElement("a");
                a.setAttribute("href", "#");

                let textArr = textarea.innerHTML.split("<br>");
                for (let idx = 0; idx < textArr.length; idx++) {
                    if (textArr[idx].replaceAll(" ", "").replaceAll("&nbsp;", "") == "" &&
                        idx < textArr.length - 1 && textArr[idx + 1].replaceAll(" ", "").replaceAll("&nbsp;", "") == "") {
                        continue;
                    }
                    a.append(
                        textArr[idx].replace(/&amp;/g, "&")
                            .replace(/&lt;/g, "<")
                            .replace(/&gt;/g, ">")
                            .replace(/&quot;/g, "\"")
                            .replace(/&#039;/g, "'")
                            .replace(/&nbsp;/g, " ")
                    );
                    a.append(document.createElement("br"));
                }

                a.removeChild(a.lastChild);

                li.append(a);
                chatList.append(li);
                chatList.scroll(chatList.scrollWidth, chatList.scrollHeight);
                e.target.textContent = "";
                _clear();
            } else if (e.key === 'Enter' && e.shiftKey) {

            }
        })

        function removeAllChildNodes(parent) {
            while (parent.firstChild) {
                parent.removeChild(parent.firstChild);
            }
        }
    </script>
</body>

</html>